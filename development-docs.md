MediaScanner 开发需求文档
1. 项目概述

目标: 开发一个基于 LLM 的高效媒体信息刮削器 (MediaScanner)。

核心技术:

    语言: Golang

    数据库: Postgres (用于存储刮削记录和缓存)

    核心引擎: 大型语言模型 (LLM)，需支持 OpenAI 风格 API 接入

    数据源: TMDB, TVDB, Bangumi 等媒体信息库 API

解决痛点:

    处理复杂、含广告、或不规范的媒体文件名。

    解决动漫等多语言/多别名媒体的识别问题。

    根据用户偏好自动规划和执行文件命名及目录结构。

    自动化监控与处理新增媒体文件。

2. 核心功能需求
2.1 LLM 集成与交互

    API 接入: 支持接入 OpenAI 兼容的 LLM API (如 OpenAI 官方 API, One-API 等)。

    Function Calling: 利用 LLM 的 Function Calling 能力，结构化地调用外部 API (TMDB, TVDB, Bangumi)。

    信息处理:

        接收输入: 单个文件名、批量文件名列表 (来自同一文件夹)、用户设定的分类目录结构、已存在的 NFO 文件 (可选)。

        处理逻辑:

            LLM 分析输入信息 (单个或批量)。

            LLM 通过 Function Calling 指示程序查询 TMDB/TVDB/Bangumi。

            程序执行查询并将结果返回给 LLM。

            LLM 确认媒体的准确名称、季/集信息、以及对应的 TMDB ID, TVDB ID, Bangumi ID 等 (对批量请求，需分别确认)。

            LLM 输出结构化的 JSON 数据，包含识别结果和目标路径规划 (对批量请求，需包含所有文件的结果)。

    批量处理优化:

        对于检测到包含较少媒体文件 (例如，少于 50 个文件) 的文件夹，程序应将该文件夹内的所有待处理媒体文件名批量组合，一次性发送给 LLM 进行处理，以减少 API 调用次数。LLM 需能理解并分别处理批量请求中的每一个文件。

    健壮性:

        当 LLM 返回为空或格式不正确时，自动重试 (最多 3 次)。

        连续 3 次失败后，触发通知机制 (见 2.6 节)，并记录失败文件。

2.2 媒体信息刮削与处理

    API 客户端: 实现与 TMDB, TVDB, Bangumi API 的交互客户端，用于获取详细媒体信息 (元数据、图片 URL 等)。

    信息获取: 根据 LLM 确认的 ID，从对应 API 获取详细的媒体信息。

    文件操作:

        根据 LLM 规划的路径和命名规则，重命名媒体文件。

        支持复制或软链接 (symlink) 媒体文件到目标目录。

2.3 文件/目录结构管理

    分类:

        支持用户自定义多级分类目录结构 (至少支持二级，可扩展至三级)。

        LLM 根据媒体信息 (如类型、地区、语言等) 自动判断并归入合适的分类目录。

        示例 (二级分类):

         - 电影
          - 外语电影
          - 国语电影
          - 动画电影
         - 电视剧
          - 综艺
          - 纪录片
          - 动画
          - 国产剧
          - 欧美剧
          - 日韩剧
          - 其他

    电视剧 (TV Shows):

        在剧集目录下，根据季度创建子目录 (e.g., Season 1, Season 2)。

        示例:

            原始文件: 七宗罪第一季第二集1080P.mkv

            目标路径: /电视剧/国产剧/七宗罪 (2014)/Season 1/七大罪 - S01E01 - 第 1 集.mp4 (文件名根据刮削信息生成)

    电影 (Movies):

        在电影目录下，创建以电影名和年份命名的子目录。

        示例:

            原始文件: 为何是你？ (2024) 1080P.mkv

            目标路径: /电影/外语电影/为何是你？ (2024)/为何是你？ (2024) - 1080p.mp4 (文件名根据刮削信息生成)

2.4 元数据与图片下载 (Emby 风格)

    NFO 文件生成:

        电视剧:

            在剧集根目录 (/电视剧/国产剧/七宗罪 (2014)/) 生成 tvshow.nfo。

            在季度目录 (/电视剧/国产剧/七宗罪 (2014)/Season 1/) 为每一集生成对应的 .nfo 文件 (e.g., 七大罪 - S01E01 - 第 1 集.nfo)。

        电影:

            在电影目录 (/电影/外语电影/为何是你？ (2024)/) 生成电影的 .nfo 文件 (e.g., 为何是你？ (2024) - 1080p.nfo)。

    图片下载:

        电视剧 (在剧集根目录):

            backdrop.jpg (背景图)

            background.jpg (背景图)

            banner.jpg (横幅)

            logo.png / clearlogo.png (透明 Logo)

            poster.jpg (海报)

            thumb.jpg (缩略图)

            季度海报 (e.g., season01-poster.jpg)

        电视剧 (在季度目录):

            剧集缩略图 (e.g., 七大罪 - S01E01 - 第 1 集-thumb.jpg)

        电影 (在电影目录):

            backdrop.jpg (背景图)

            clearlogo.png (透明 Logo)

            poster.jpg (海报)

    图片来源: TMDB, TVDB, Bangumi API。

2.5 自动化扫描与过滤

    周期性扫描: 程序应能配置为定期 (例如，每 5 分钟) 扫描指定的本地媒体库入口目录及其子目录。

    自动触发: 一旦扫描发现新的视频媒体文件 (基于文件扩展名判断，如 .mkv, .mp4, .avi, .ts 等)，自动将其加入处理队列。

    内容过滤:

        使用正则表达式或其他规则，过滤掉常见的不需要刮削的文件或文件夹。

        过滤示例: 包含 sample, trailer, extras, featurettes 等关键字的文件/目录；特定格式的文件 (如 .txt, .srt 在没有对应视频文件时)；或用户自定义的排除规则。

        过滤后的文件不进入后续处理流程。

2.6 通知系统

    平台: Telegram

    成功通知:

        发送到指定 频道 (Channel)。

        内容: 刮削成功的媒体信息 (片名、季/集数、媒体库信息摘要、所属分类 - 无需完整路径)。

    异常/待处理通知:

        发送到指定 管理群组 (Group)。

        触发条件:

            LLM 连续 3 次未能正确处理某个文件或批量请求中的某个文件。

            LLM 对识别结果不确定，需要人工干预。

        内容: 提示需要管理员手动处理，并附带相关文件信息。

3. 技术注意事项

    Bangumi API 限额:

        优先使用 TMDB/TVDB 进行搜索。

        如果 TMDB/TVDB 结果表明是动漫类型，或者 LLM 判断为动漫，则再调用 Bangumi API 进行补充搜索和信息获取，以减少 Bangumi 的调用频率。

    数据库设计:

        设计合理的表结构存储刮削记录 (原始文件名、目标路径、使用的 ID、刮削时间、处理状态等)。

        考虑缓存从 API 获取的媒体信息，减少重复查询。

    并发处理: 考虑并发处理多个文件/文件夹的刮削任务，提高效率，需注意 API 调用频率限制。

    配置管理: 用户的 API Keys, 分类结构, 扫描间隔, 过滤规则, 批量处理阈值, 通知设置等应通过配置文件或环境变量进行管理。

    状态管理: 需要跟踪每个文件的处理状态 (待处理、处理中、成功、失败、待人工处理)，避免重复处理或遗漏。

4. 工作流程

    启动与监控: 程序启动后，按设定的时间间隔 (e.g., 5 分钟) 自动扫描指定的媒体库入口目录。

    文件发现与过滤:

        检测新增或未处理的视频文件。

        应用正则表达式和规则进行过滤，排除不需要处理的文件。

    预处理与批处理判断:

        对通过过滤的文件，获取文件名。

        判断文件所在文件夹是否适合进行批量处理 (e.g., 文件数 < 50 且均为待处理)。

        检查是否存在 NFO 文件。

    LLM 调用:

        批量: 将符合条件的文件夹内所有文件名、分类结构、(可选) NFO 内容组合后，一次性发送给 LLM。

        单个: 将单个文件名、分类结构、(可选) NFO 内容发送给 LLM。

    信息查询 (Function Call):

        LLM 指示程序查询 TMDB/TVDB/Bangumi。

        (Bangumi 策略: 优先 TMDB/TVDB，动漫确认后再查 Bangumi)。

        程序执行查询，结果返回 LLM。

    LLM 确认与规划: LLM 确认媒体信息 (ID, 季/集) 并规划目标路径和文件名，输出 JSON (包含批量请求中所有文件的结果)。

    (失败重试与处理): 若 LLM 输出异常或无法处理某个文件 (即使在批量请求中)，记录该文件并重试最多 3 次。若持续失败，发送通知到管理群组，标记该文件为“待人工处理”，继续处理其他文件。

    API 获取详情: 程序使用确认的 ID 调用相应 API (TMDB/TVDB/Bangumi) 获取详细元数据和图片 URL。

    文件操作:

        创建目标目录结构。

        复制或软链接文件并重命名。

    元数据与图片下载:

        生成 NFO 文件。

        下载所需图片。

    状态更新与通知:

        更新数据库中文件的处理状态为“成功”。

        发送成功通知到指定 Telegram 频道。

    循环: 处理队列中的下一个文件/批量任务，直至队列为空，等待下一次扫描周期。